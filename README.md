# AI营养餐厅系统性能优化

这个项目实现了AI营养餐厅系统的性能优化，采用了分阶段优化策略，包括高优先级、中优先级和长期优化。

## 优化内容概览

### 1. 高优先级优化（已完成）

- **索引策略优化**
  - 为用户、商家、菜品和订单集合创建合适的索引
  - 为商家模型添加地理空间索引(2dsphere)
  - 为营养推荐和健康数据模型添加TTL索引

- **基础缓存层**
  - 营养评估结果缓存
  - 用户偏好缓存

- **批量操作优化**
  - 将单条记录查询改为批量查询
  - 订单营养汇总计算优化

### 2. 中优先级优化（已完成）

- **查询优化**
  - 使用聚合管道替代多次查询
  - 优化营养评估逻辑

- **数据模型优化**
  - 商家销售统计预聚合集合
  - 用户模型缓存字段设计

- **慢查询监控**
  - 慢查询日志和性能指标收集
  - 性能报告生成和告警机制

### 3. 长期优化（已完成）

- **读写分离**
  - 主从数据库架构
  - 模型工厂支持读写分离路由

- **多级缓存**
  - 内存缓存(Node-Cache)
  - 分布式缓存(Redis)

- **数据分片**
  - 按时间、地理位置、用户ID等策略分片
  - 分片查询与结果聚合

## 技术栈

- Node.js + Express
- MongoDB (支持读写分离)
- Redis (可选的分布式缓存)
- node-cache (内存缓存)

## 如何启动

1. 安装依赖
```
npm install
```

2. 配置环境变量
编辑 `.env` 文件设置数据库连接等参数

3. 启动服务器
```
npm start
```

开发模式：
```
npm run dev
```

## 性能监控

系统提供了性能监控API端点：

- `/api/admin/db-performance` - 查看数据库性能报告
- `/api/admin/cache-stats` - 查看缓存统计信息

## 注意事项

- 读写分离和分片功能默认处于关闭状态，可通过环境变量开启
- Redis缓存需要安装Redis服务器才能使用
- 在生产环境中，请务必修改JWT密钥
