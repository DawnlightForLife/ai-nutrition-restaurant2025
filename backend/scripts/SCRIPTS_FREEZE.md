# 脚本结构冻结文档 (SCRIPTS_FREEZE.md)

**版本:** 1.0  
**状态:** 已冻结  
**更新日期:** 2025-05-17  
**编制人:** 系统架构组

## 📑 目录

- [1. 概述](#1-概述)
- [2. 设计原则](#2-设计原则)
- [3. 目录结构](#3-目录结构)
- [4. 模块详情](#4-模块详情)
  - [4.1 数据库模块 (db/)](#41-数据库模块-db)
  - [4.2 数据生成模块 (data/)](#42-数据生成模块-data)
  - [4.3 用户管理模块 (user/)](#43-用户管理模块-user)
  - [4.4 系统监控模块 (monitor/)](#44-系统监控模块-monitor)
  - [4.5 系统检查模块 (check/)](#45-系统检查模块-check)
  - [4.6 启动脚本模块 (startup/)](#46-启动脚本模块-startup)
  - [4.7 可视化工具模块 (viz/)](#47-可视化工具模块-viz)
  - [4.8 环境配置与统一入口](#48-环境配置与统一入口)
- [5. 冻结范围](#5-冻结范围)
- [6. 更新与维护](#6-更新与维护)

## 1. 概述

本文档定义了智能营养餐厅系统的脚本结构，包括数据库初始化、数据迁移、测试数据生成、系统监控和文档生成等各类工具脚本。脚本系统为开发、测试、部署和维护提供了必要的辅助工具，确保系统在各个阶段的正常运行。

脚本层作为系统工具链的关键组成部分，其结构冻结对保障开发和运维流程的一致性和可靠性至关重要。

## 2. 设计原则

- **模块化原则**: 脚本按功能领域分组，形成独立模块，降低耦合
- **职责单一原则**: 每个脚本专注于单一任务，避免过度复杂化
- **环境隔离原则**: 脚本执行环境与生产环境隔离，避免意外影响
- **可复用原则**: 通用功能抽象为可重用组件，减少代码重复
- **命名语义化原则**: 脚本名称清晰表达其功能和用途
- **统一入口原则**: 提供统一执行入口，简化操作流程
- **文档完备原则**: 脚本用途和执行方式有清晰注释和文档

## 3. 目录结构

脚本系统采用以下目录结构：

```
/backend/scripts/
├── db/                           # 数据库初始化与迁移脚本
│   ├── initializeDatabase.js     # 初始化数据库集合结构
│   ├── resetDatabase.js          # 重置数据库内容（开发用）
│   ├── migrateToSharding.js      # 迁移数据到 MongoDB 分片结构
│   ├── schemaFreezeVerification.js # 校验模型 schema 冻结状态
│   ├── migration-nutrition-profile-enum.js # 补全旧档案的 enum 字段
│   ├── directMigration.js        # 低级别结构迁移入口
│   ├── runMigration.js           # 正式迁移器主入口
│   └── fixModelFactory.js        # 修复 modelFactory 引用问题
│
├── data/                         # 模拟数据、mock 数据、演示数据生成
│   ├── generateSampleData.js     # 生成通用演示数据
│   ├── generateMockHealthData.js # 生成 mock 营养数据
│   └── initTestUser.js           # 创建测试用用户
│
├── user/                         # 初始化用户、补充用户属性
│   └── initAdmin.js              # 初始化管理员账号
│
├── monitor/                      # 性能监控、回滚、分片状态检查
│   ├── monitorShards.js          # 查看各 shard 节点状态
│   ├── queryRegressionEvaluator.js # 查询变更性能评估器
│   └── queryRollback.js          # 查询结构回退（字段降级）
│
├── check/                        # 所有校验类脚本：模型、权限、状态等
│   ├── checkAdmin.js             # 检查管理员是否存在
│   ├── check_model_imports.js    # 校验模型引用情况
│   └── checkMigrationStatus.js   # 校验 migration 是否执行成功
│
├── startup/                      # 启动相关 shell 脚本与检查脚本
│   ├── startup_check.js          # 启动检查（deprecated 可归档）
│   ├── docker_startup.sh         # 启动 docker 环境前脚本
│   └── deploy-with-query-eval.sh # 启动部署（含查询评估）
│
├── viz/                          # schema 可视化、文档输出等开发辅助
│   ├── schemaVisualization.js    # 生成 schema 可视化 HTML
│   └── schemaToMarkdown.js       # 可选生成 markdown 文档结构
│
├── .env.local                    # 仅用于脚本执行的 dev 环境变量
├── README.md                     # 每个脚本模块说明与执行方式
└── runAll.js                     # 统一执行主入口（如创建用户+数据）
```

## 4. 模块详情

### 4.1 数据库模块 (db/)

**用途**: 提供数据库初始化、重置、迁移和模式验证功能

| 文件名 | 功能描述 | 独立执行 | 环境变量依赖 | 聚合执行 | 冻结状态 |
|-------|---------|---------|------------|---------|---------|
| **initializeDatabase.js** | 初始化数据库集合结构、索引和基础配置 | ✅ 是 | ✅ 是 | ✅ 是 | ✅ 已冻结 |
| **resetDatabase.js** | 清空并重置数据库内容（仅开发环境使用） | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |
| **migrateToSharding.js** | 将现有数据迁移到MongoDB分片结构 | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |
| **schemaFreezeVerification.js** | 验证模型schema是否符合冻结标准 | ✅ 是 | ❌ 否 | ❌ 否 | ✅ 已冻结 |
| **migration-nutrition-profile-enum.js** | 为旧版营养档案补充枚举字段 | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |
| **directMigration.js** | 执行低级别数据库结构迁移操作 | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |
| **runMigration.js** | 执行正式结构迁移计划的主入口 | ✅ 是 | ✅ 是 | ✅ 是 | ✅ 已冻结 |
| **fixModelFactory.js** | 修复模型工厂的引用问题 | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |

**冻结说明**: 结构已冻结，建议以此为基础维护数据迁移与初始化机制

### 4.2 数据生成模块 (data/)

**用途**: 生成系统测试和演示所需的模拟数据

| 文件名 | 功能描述 | 独立执行 | 环境变量依赖 | 聚合执行 | 冻结状态 |
|-------|---------|---------|------------|---------|---------|
| **generateSampleData.js** | 生成系统通用演示数据（餐厅、菜品等） | ✅ 是 | ✅ 是 | ✅ 是 | ✅ 已冻结 |
| **generateMockHealthData.js** | 生成模拟用户健康和营养数据 | ✅ 是 | ✅ 是 | ✅ 是 | ✅ 已冻结 |
| **initTestUser.js** | 创建各角色的测试用户账号 | ✅ 是 | ✅ 是 | ✅ 是 | ✅ 已冻结 |

**冻结说明**: 结构已冻结，建议以此为基础拓展测试数据生成机制

### 4.3 用户管理模块 (user/)

**用途**: 管理系统用户初始化和特殊角色设置

| 文件名 | 功能描述 | 独立执行 | 环境变量依赖 | 聚合执行 | 冻结状态 |
|-------|---------|---------|------------|---------|---------|
| **initAdmin.js** | 初始化系统管理员账号及权限 | ✅ 是 | ✅ 是 | ✅ 是 | ✅ 已冻结 |

**冻结说明**: 结构已冻结，建议以此为基础维护用户管理脚本

### 4.4 系统监控模块 (monitor/)

**用途**: 提供系统性能监控、状态查询和问题修复工具

| 文件名 | 功能描述 | 独立执行 | 环境变量依赖 | 聚合执行 | 冻结状态 |
|-------|---------|---------|------------|---------|---------|
| **monitorShards.js** | 查看各分片节点状态和负载情况 | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |
| **queryRegressionEvaluator.js** | 评估查询性能变更的影响 | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |
| **queryRollback.js** | 将查询结构回退到之前版本（字段降级） | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |

**冻结说明**: 结构已冻结，建议以此为基础维护系统监控工具

### 4.5 系统检查模块 (check/)

**用途**: 提供各类系统状态和配置检查工具

| 文件名 | 功能描述 | 独立执行 | 环境变量依赖 | 聚合执行 | 冻结状态 |
|-------|---------|---------|------------|---------|---------|
| **checkAdmin.js** | 检查管理员账号是否存在及权限是否正确 | ✅ 是 | ✅ 是 | ✅ 是 | ✅ 已冻结 |
| **check_model_imports.js** | 校验模型引用关系是否正确 | ✅ 是 | ❌ 否 | ❌ 否 | ✅ 已冻结 |
| **checkMigrationStatus.js** | 验证数据迁移是否执行成功 | ✅ 是 | ✅ 是 | ✅ 是 | ✅ 已冻结 |

**冻结说明**: 结构已冻结，建议以此为基础拓展系统检查工具

### 4.6 启动脚本模块 (startup/)

**用途**: 提供系统启动前检查和环境准备脚本

| 文件名 | 功能描述 | 独立执行 | 环境变量依赖 | 聚合执行 | 冻结状态 |
|-------|---------|---------|------------|---------|---------|
| **startup_check.js** | 启动前系统完整性检查（已弃用） | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |
| **docker_startup.sh** | Docker环境启动前准备工作脚本 | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |
| **deploy-with-query-eval.sh** | 部署启动脚本（含查询性能评估） | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |

**冻结说明**: 结构已冻结，建议以此为基础维护系统启动脚本

### 4.7 可视化工具模块 (viz/)

**用途**: 为开发人员提供数据模型和系统结构可视化工具

| 文件名 | 功能描述 | 独立执行 | 环境变量依赖 | 聚合执行 | 冻结状态 |
|-------|---------|---------|------------|---------|---------|
| **schemaVisualization.js** | 生成数据模型关系的HTML可视化图表 | ✅ 是 | ❌ 否 | ❌ 否 | ✅ 已冻结 |
| **schemaToMarkdown.js** | 将数据模型导出为Markdown文档 | ✅ 是 | ❌ 否 | ❌ 否 | ✅ 已冻结 |

**冻结说明**: 结构已冻结，建议以此为基础维护开发辅助工具

### 4.8 环境配置与统一入口

**用途**: 提供脚本环境配置和统一执行入口

| 文件名 | 功能描述 | 独立执行 | 环境变量依赖 | 聚合执行 | 冻结状态 |
|-------|---------|---------|------------|---------|---------|
| **.env.local** | 脚本专用环境变量配置（与生产环境隔离） | ❌ 否 | ❌ 否 | ✅ 是 | ✅ 已冻结 |
| **README.md** | 脚本目录说明文档，包含各模块用途和执行方式 | ❌ 否 | ❌ 否 | ❌ 否 | ✅ 已冻结 |
| **runAll.js** | 统一执行入口，可选择性执行特定类型脚本 | ✅ 是 | ✅ 是 | ❌ 否 | ✅ 已冻结 |

**runAll.js 说明**:
- 作为统一执行入口，支持命令行参数选择执行特定脚本组
- 按照预设流程顺序执行相关脚本
- 提供日志记录和错误处理
- 确保脚本间依赖关系正确
- 支持 `--init`、`--data`、`--check` 等选项控制执行范围

**.env.local 说明**:
- 专用于脚本执行的环境变量配置
- 与生产环境严格隔离，避免意外影响
- 包含数据库连接、测试账户信息等敏感配置
- 不应纳入版本控制，仅作为模板存在

## 5. 冻结范围

以下脚本系统内容被定义为冻结状态：

1. **目录结构**
   - 脚本模块的分类和组织方式
   - 文件命名规范和存放位置

2. **核心流程**
   - 数据库初始化和迁移流程
   - 测试数据生成流程
   - 系统检查和监控流程

3. **统一入口机制**
   - 通过 runAll.js 的聚合执行模式
   - 环境变量隔离机制

## 6. 更新与维护

尽管脚本系统结构已冻结，但特定情况下允许进行受控更新：

1. **允许的变更**
   - 添加新的脚本文件（遵循现有分类和命名规范）
   - 优化现有脚本内部实现（不改变接口和功能边界）
   - 更新环境变量配置项（根据系统功能演进）

2. **变更流程**
   - 提交脚本变更方案
   - 架构评审委员会审核
   - 测试环境验证
   - 更新脚本文档

3. **注意事项**
   - 新增脚本应添加到 README.md 文档中
   - 重要脚本需集成到 runAll.js 统一入口
   - 脚本应具备错误处理和日志记录
   - 避免在脚本中包含敏感信息

---
⚠️ **注意**: 本文档定义的脚本结构已冻结，未经架构委员会批准，不得更改脚本架构和组织方式。任何新增脚本必须遵循现有的分类和命名规范。 