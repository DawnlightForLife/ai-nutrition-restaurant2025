# 定时任务结构冻结文档 (JOBS_FREEZE.md)

**版本:** 1.0  
**状态:** 已冻结  
**更新日期:** 2025-05-17  
**编制人:** 系统架构组

## 📑 目录

- [1. 概述](#1-概述)
- [2. 设计原则](#2-设计原则)
- [3. 目录结构](#3-目录结构)
- [4. 调度器与注册机制](#4-调度器与注册机制)
- [5. 任务模块详情](#5-任务模块详情)
- [6. 冻结范围](#6-冻结范围)
- [7. 更新与维护](#7-更新与维护)

## 1. 概述

本文档定义了智能营养餐厅系统的定时任务结构，包括各类周期性执行的后台任务。定时任务系统负责处理不需要即时响应的操作，如数据清理、报告生成、定期通知等，确保系统能自动化执行周期性工作。

定时任务层作为系统自动化处理的关键组成部分，其结构冻结对保障系统稳定性和可维护性至关重要。

## 2. 设计原则

- **单一职责原则**: 每个任务脚本专注于单一功能，避免过度复杂化
- **调度分离原则**: 任务逻辑与调度机制分离，提高可测试性和维护性
- **统一注册原则**: 所有任务通过统一入口注册，便于管理和监控
- **错误隔离原则**: 一个任务的失败不应影响其他任务的执行
- **可观测性原则**: 任务执行需记录详细日志，支持监控和追踪
- **幂等性原则**: 任务设计应考虑幂等性，避免重复执行导致数据不一致
- **资源控制原则**: 后台任务应控制资源使用，避免影响在线服务性能

## 3. 目录结构

定时任务系统采用以下目录结构：

```
/backend/jobs/
├── index.js                     # 任务注册与初始化入口
├── scheduler.js                 # 调度器封装与工具函数
├── recommendJob.js              # 每日生成推荐任务
├── auditCleanupJob.js           # 审计日志定期清理任务
├── orderAutoCancelJob.js        # 超时未支付订单自动取消任务
├── notifySubscriptionRenewal.js # 到期订阅用户提醒推送任务
└── logRotationJob.js            # 日志文件定期轮转或归档任务
```

## 4. 调度器与注册机制

### 调度器封装 (scheduler.js)

调度器封装模块提供统一的任务调度接口，封装底层调度引擎细节，为所有定时任务提供基础设施支持。

**核心职责**:
- 封装底层调度库（如 `node-cron` 或 `agenda`）
- 提供标准化的任务注册接口
- 支持任务执行状态记录和监控
- 实现任务错误处理和重试机制
- 提供任务锁定机制，防止任务重叠执行

**冻结状态**: ✅ 架构已冻结

### 任务注册入口 (index.js)

任务注册入口负责集中注册和初始化所有定时任务，是整个定时任务系统的核心控制器。

**核心职责**:
- 引入并注册所有定时任务
- 根据环境配置启用或禁用特定任务
- 配置任务执行优先级和资源限制
- 提供任务健康检查接口
- 处理系统启动和关闭时的任务管理

**冻结状态**: ✅ 架构已冻结

## 5. 任务模块详情

| 文件名 | 调度频率 | 调度引擎 | 自动挂载 | 依赖服务层 | 冻结状态 | 描述 |
|-------|---------|---------|---------|-----------|---------|------|
| **recommendJob.js** | 🕒 每日凌晨 | node-cron | ✅ 是 | ✅ 营养推荐服务 | ✅ 已冻结 | 基于用户历史数据和健康状况生成每日营养餐推荐 |
| **auditCleanupJob.js** | 🕒 每周一次 | node-cron | ✅ 是 | ✅ 审计服务 | ✅ 已冻结 | 清理超过保留期限的审计日志数据，保障系统存储空间 |
| **orderAutoCancelJob.js** | 🕒 每5分钟 | node-cron | ✅ 是 | ✅ 订单服务 | ✅ 已冻结 | 自动取消超过预设时间未支付的订单，释放库存 |
| **notifySubscriptionRenewal.js** | 🕒 每日上午 | node-cron | ✅ 是 | ✅ 用户服务、通知服务 | ✅ 已冻结 | 向即将到期的订阅用户发送续订提醒通知 |
| **logRotationJob.js** | 🕒 每日午夜 | node-cron | ✅ 是 | ❌ 无服务依赖 | ✅ 已冻结 | 执行日志文件的轮转、压缩和归档，优化日志存储 |

### 任务详细说明

#### recommendJob.js (每日推荐生成任务)

**用途**: 基于用户档案、营养需求和历史数据，为活跃用户生成个性化的餐饮推荐。

**关键特性**:
- 调度频率: 每日凌晨2点执行
- 资源控制: 批处理模式分批处理用户数据
- 服务依赖: 依赖营养分析服务和用户档案服务
- 数据流: 读取用户数据 → 计算推荐 → 存储结果 → 更新缓存

**冻结说明**: 调度结构与触发逻辑已冻结，不建议改名或迁移目录

#### auditCleanupJob.js (审计日志清理任务)

**用途**: 根据数据留存策略，定期清理过期的审计日志记录，优化数据库性能。

**关键特性**:
- 调度频率: 每周日凌晨3点执行
- 资源控制: 分批处理，避免长事务
- 服务依赖: 依赖审计服务和系统配置服务
- 数据流: 查询过期记录 → 备份 → 清理 → 记录结果

**冻结说明**: 调度结构与触发逻辑已冻结，不建议改名或迁移目录

#### orderAutoCancelJob.js (订单自动取消任务)

**用途**: 自动取消超过预设支付时间限制的未支付订单，释放库存和资源。

**关键特性**:
- 调度频率: 每5分钟执行一次
- 资源控制: 轻量级扫描，低影响
- 服务依赖: 依赖订单服务和库存服务
- 数据流: 查询超时订单 → 执行取消 → 通知用户 → 更新库存

**冻结说明**: 调度结构与触发逻辑已冻结，不建议改名或迁移目录

#### notifySubscriptionRenewal.js (订阅续订提醒任务)

**用途**: 向即将到期的订阅用户发送续订提醒，提高续订转化率。

**关键特性**:
- 调度频率: 每日上午10点执行
- 通知策略: 到期前7天、3天、1天发送阶梯式提醒
- 服务依赖: 依赖用户服务、通知服务和订阅服务
- 数据流: 查询即将到期用户 → 生成通知内容 → 发送通知 → 记录发送状态

**冻结说明**: 调度结构与触发逻辑已冻结，不建议改名或迁移目录

#### logRotationJob.js (日志轮转任务)

**用途**: 执行服务器日志文件的轮转、压缩和归档，优化系统存储空间。

**关键特性**:
- 调度频率: 每日午夜12点执行
- 执行方式: 直接调用系统命令
- 服务依赖: 无服务层依赖，直接操作文件系统
- 数据流: 扫描日志目录 → 轮转日志 → 压缩归档 → 删除过期日志

**冻结说明**: 调度结构与触发逻辑已冻结，不建议改名或迁移目录

## 6. 冻结范围

以下定时任务系统内容被定义为冻结状态：

1. **目录结构**
   - 任务文件的存放位置和命名规范
   - 调度器与任务注册的分离机制

2. **核心任务类型**
   - 数据清理类任务架构
   - 通知类任务架构
   - 计算生成类任务架构

3. **调度机制**
   - 基于 node-cron 的调度模式
   - 通过 index.js 的统一注册模式
   - 调度频率的设置方式

## 7. 更新与维护

尽管定时任务系统结构已冻结，但特定情况下允许进行受控更新：

1. **允许的变更**
   - 添加新的定时任务（遵循现有结构模式）
   - 调整现有任务的调度频率（基于性能和业务需求）
   - 优化任务内部实现（不改变接口和依赖关系）

2. **变更流程**
   - 提交任务变更方案
   - 架构评审委员会审核
   - 测试环境验证
   - 分阶段部署（开发->测试->生产）

3. **注意事项**
   - 新任务必须注册到 index.js 中
   - 调整频率需评估系统负载影响
   - 任务逻辑变更需确保幂等性
   - 所有变更必须记录在任务变更日志中

---
⚠️ **注意**: 本文档定义的定时任务结构已冻结，未经架构委员会批准，不得更改任务架构和调度机制。新增任务必须遵循现有结构模式。 