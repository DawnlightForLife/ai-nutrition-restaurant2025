# 钩子系统结构冻结说明 (HOOKS_FREEZE.md)

**版本:** 1.0  
**状态:** 已冻结  
**更新日期:** 2025-05-17  
**编制人:** 系统架构组

## 📑 目录

- [1. 概述](#1-概述)
- [2. 设计原则](#2-设计原则)
- [3. 目录结构](#3-目录结构)
- [4. 钩子模块详情](#4-钩子模块详情)
  - [4.1 用户相关钩子 (user/)](#41-用户相关钩子-user)
  - [4.2 营养相关钩子 (nutrition/)](#42-营养相关钩子-nutrition)
  - [4.3 咨询相关钩子 (consult/)](#43-咨询相关钩子-consult)
  - [4.4 订单相关钩子 (order/)](#44-订单相关钩子-order)
  - [4.5 商家相关钩子 (merchant/)](#45-商家相关钩子-merchant)
  - [4.6 社区相关钩子 (forum/)](#46-社区相关钩子-forum)
  - [4.7 管理相关钩子 (admin/)](#47-管理相关钩子-admin)
  - [4.8 反馈相关钩子 (feedback/)](#48-反馈相关钩子-feedback)
  - [4.9 通知相关钩子 (notification/)](#49-通知相关钩子-notification)
  - [4.10 系统相关钩子 (system/)](#410-系统相关钩子-system)
  - [4.11 公共工具 (utils/)](#411-公共工具-utils)
- [5. 钩子触发点清单](#5-钩子触发点清单)
- [6. 钩子注册与扩展](#6-钩子注册与扩展)
- [7. 冻结范围](#7-冻结范围)
- [8. 更新与维护](#8-更新与维护)

## 1. 概述

本文档定义了智能营养餐厅系统的钩子(Hooks)结构，钩子系统基于事件驱动架构，通过在关键业务节点触发预定义的行为，实现系统功能的灵活扩展和解耦。钩子系统允许根据业务场景动态注册和移除行为，而不需要修改核心业务逻辑。

钩子层作为系统扩展点的关键载体，其结构冻结对保障系统稳定性和一致性至关重要。本文档详细说明了各个钩子模块的用途、触发时机和扩展方式，为开发团队提供统一的扩展点参考。

## 2. 设计原则

- **事件驱动原则**: 所有钩子基于业务事件触发，采用观察者模式实现松耦合
- **单一职责原则**: 每个钩子专注于处理特定业务场景下的扩展需求
- **命名一致性原则**: 钩子命名采用 `on{Entity}{Action}` 格式，清晰表达触发时机
- **异步处理原则**: 钩子默认采用异步处理模式，避免阻塞主业务流程
- **可扩展原则**: 钩子系统支持动态注册和移除，实现功能的动态扩展
- **可测试原则**: 钩子设计便于单元测试，支持模拟事件触发和结果验证
- **可监控原则**: 钩子执行情况可追踪和监控，便于问题排查和性能优化

## 3. 目录结构

钩子系统采用以下目录结构：

```
/backend/hooks/
├── user/
│   ├── onUserRegistered.js               # 用户注册后初始化数据
│   ├── onUserDeleted.js                  # 用户注销时清除关联信息
│   ├── onProfileCompleted.js             # 用户完成档案时触发推荐或提示
│   └── onLoginSuccess.js                 # 登录成功后触发记录或推荐提示
│
├── nutrition/
│   ├── onRecommendationGenerated.js      # 推荐生成成功 → 推送/统计
│   └── onProfileUpdated.js               # 档案修改后触发模型重评估
│
├── consult/
│   ├── onConsultationCreated.js          # 提交咨询 → 通知营养师
│   ├── onConsultationReplied.js          # 营养师回复 → 通知用户
│   └── onConsultationClosed.js           # 咨询结束 → 评分或推荐触发
│
├── order/
│   ├── onOrderCreated.js                 # 用户下单成功 → 发起支付倒计时
│   ├── onOrderPaid.js                    # 支付成功 → 通知商家/积分结算
│   ├── onOrderCanceled.js                # 订单超时或主动取消 → 发通知
│   └── onSubscriptionRenewed.js          # 订阅自动续费成功 → 推送下一轮推荐
│
├── merchant/
│   ├── onMerchantRegistered.js           # 商家注册成功 → 进入审核流程
│   ├── onMerchantApproved.js             # 商家审核通过 → 解锁功能
│   └── onDishPublished.js                # 新菜品上架 → 推送推荐系统刷新
│
├── forum/
│   ├── onPostCreated.js                  # 发帖后 → 增加积分/通知审核
│   └── onCommentAdded.js                 # 评论后 → 通知作者或点赞者
│
├── admin/
│   ├── onUserReported.js                 # 有人举报用户/帖 → 通知审核员
│   └── onAuditLogCreated.js              # 操作记录新建 → 若异常可自动报警
│
├── feedback/
│   └── onFeedbackSubmitted.js            # 用户提交建议 → 发通知或记录工单
│
├── notification/
│   └── onNotificationSent.js             # 系统通知发送后记录日志
│
├── system/
│   └── onConfigChanged.js                # 配置参数修改时触发系统同步/日志记录
│
├── utils/
│   └── registerHook.js                   # 通用注册 + 分发（观察者/事件系统）
│
└── index.js                              # 导出所有 hooks 注册函数
```

## 4. 钩子模块详情

### 4.1 用户相关钩子 (user/)

**用途**: 处理用户生命周期相关事件，包括注册、登录、档案更新和账号注销等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onUserRegistered.js** | 用户注册成功后，初始化用户偏好设置、创建默认营养档案、发送欢迎通知 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onUserDeleted.js** | 用户账号注销时，清理用户关联数据、撤销授权、发送确认通知 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onProfileCompleted.js** | 用户完成营养档案填写后，触发AI推荐算法、提示用户下一步操作 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onLoginSuccess.js** | 用户登录成功后，更新在线状态、记录登录信息、推送未读消息 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.2 营养相关钩子 (nutrition/)

**用途**: 处理用户营养档案和AI推荐相关事件，包括推荐生成和档案更新等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onRecommendationGenerated.js** | AI推荐生成成功后，向用户推送通知、记录推荐统计数据、更新用户画像 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onProfileUpdated.js** | 用户营养档案更新后，触发模型重新评估、更新推荐结果、记录变更历史 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.3 咨询相关钩子 (consult/)

**用途**: 处理营养咨询流程相关事件，包括咨询创建、回复和结束等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onConsultationCreated.js** | 用户提交咨询后，通知营养师、记录咨询统计、安排自动回复 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onConsultationReplied.js** | 营养师回复咨询后，通知用户、更新咨询状态、记录回复时间 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onConsultationClosed.js** | 咨询结束后，触发用户评分、推荐后续操作、更新咨询统计 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.4 订单相关钩子 (order/)

**用途**: 处理订单和订阅相关事件，包括订单创建、支付、取消和订阅续费等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onOrderCreated.js** | 用户下单成功后，发起支付倒计时、预留库存、发送订单确认通知 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onOrderPaid.js** | 订单支付成功后，通知商家、结算积分/佣金、生成发票、更新销售统计 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onOrderCanceled.js** | 订单取消后，恢复库存、发送取消通知、处理退款、更新订单统计 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onSubscriptionRenewed.js** | 订阅自动续费成功后，延长服务期限、推送新一轮推荐、发送续费通知 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.5 商家相关钩子 (merchant/)

**用途**: 处理商家和菜品相关事件，包括商家注册、审核和菜品上架等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onMerchantRegistered.js** | 商家注册成功后，启动资质审核流程、发送指引通知、初始化商家账户 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onMerchantApproved.js** | 商家审核通过后，解锁商家功能、发送通知、更新商家目录 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onDishPublished.js** | 新菜品上架后，更新推荐系统索引、发送新品通知、记录菜品统计 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.6 社区相关钩子 (forum/)

**用途**: 处理社区内容相关事件，包括帖子发布和评论新增等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onPostCreated.js** | 用户发帖后，增加积分、触发内容审核、更新话题热度、发送关注通知 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onCommentAdded.js** | 用户评论后，通知作者、增加积分、更新帖子活跃度、触发内容审核 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.7 管理相关钩子 (admin/)

**用途**: 处理系统管理相关事件，包括用户举报和审计日志等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onUserReported.js** | 用户举报内容后，创建审核任务、通知审核员、临时标记内容状态 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |
| **onAuditLogCreated.js** | 操作日志创建后，检测异常操作、触发安全预警、更新风控规则 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.8 反馈相关钩子 (feedback/)

**用途**: 处理用户反馈相关事件，包括建议提交等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onFeedbackSubmitted.js** | 用户提交反馈后，创建工单、通知客服、发送确认通知、记录反馈统计 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.9 通知相关钩子 (notification/)

**用途**: 处理系统通知相关事件，包括通知发送等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onNotificationSent.js** | 系统通知发送后，记录发送日志、更新通知统计、处理发送失败情况 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.10 系统相关钩子 (system/)

**用途**: 处理系统配置相关事件，包括配置变更等场景的扩展行为。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **onConfigChanged.js** | 系统配置变更后，同步更新缓存、记录变更日志、通知相关服务刷新配置 | ⏳ 异步执行 | 🔄 通过 registerHook 调用 | ✅ 已冻结 |

**冻结说明**: 钩子结构已冻结，建议通过注册表动态扩展，不直接改名或调整触发时机。

### 4.11 公共工具 (utils/)

**用途**: 提供钩子系统的公共工具和基础设施，支持钩子的注册、管理和调用。

| 文件名 | 功能说明 | 执行方式 | 调用来源 | 冻结状态 |
|-------|---------|--------|---------|--------|
| **registerHook.js** | 通用钩子注册和事件分发机制，实现观察者模式，支持同步和异步钩子执行 | 🔄 同步/异步均支持 | ⚙️ 被业务层调用 | ✅ 已冻结 |

**工具模块详情**:

- **registerHook.js**: 实现基于事件的钩子注册和调用机制，支持以下功能：
  - 钩子注册和注销
  - 钩子排序和优先级管理
  - 同步和异步钩子执行控制
  - 钩子执行错误处理和日志记录
  - 条件性钩子触发
  - 钩子链执行控制（中断或继续）

**index.js 文件说明**:
- 统一导出所有钩子模块，提供统一的接口给业务层使用
- 实现钩子的自动注册和初始化
- 提供钩子的统一管理接口，如列举所有钩子、查询钩子状态等

**冻结说明**: 工具模块结构已冻结，建议保持接口稳定，内部实现可优化。

## 5. 钩子触发点清单

以下是系统中已定义的钩子触发点及其推荐使用的钩子：

| **模块** | **触发动作** | **推荐钩子**                  |
| ------ | -------- | ------------------------- |
| 用户     | 注册       | onUserRegistered          |
| 用户     | 登录       | onLoginSuccess            |
| 用户     | 完成档案     | onProfileCompleted        |
| 用户     | 注销账号     | onUserDeleted             |
| 营养推荐   | 推荐生成成功   | onRecommendationGenerated |
| 营养推荐   | 档案更新后    | onProfileUpdated          |
| 咨询     | 创建       | onConsultationCreated     |
| 咨询     | 营养师答复    | onConsultationReplied     |
| 咨询     | 咨询结束     | onConsultationClosed      |
| 订单     | 下单       | onOrderCreated            |
| 订单     | 支付成功     | onOrderPaid               |
| 订单     | 取消       | onOrderCanceled           |
| 订阅     | 自动续费     | onSubscriptionRenewed     |
| 商家     | 注册成功     | onMerchantRegistered      |
| 商家     | 审核通过     | onMerchantApproved        |
| 商家     | 新菜品上架    | onDishPublished           |
| 帖子     | 发布       | onPostCreated             |
| 评论     | 新增评论     | onCommentAdded            |
| 管理     | 用户举报     | onUserReported            |
| 管理     | 操作日志新增   | onAuditLogCreated         |
| 系统     | 修改配置项    | onConfigChanged           |
| 反馈     | 提交反馈     | onFeedbackSubmitted       |
| 通知     | 发送完成     | onNotificationSent        |

## 6. 钩子注册与扩展

钩子系统支持两种注册和扩展方式：

### 6.1 静态注册

在 `index.js` 中统一注册所有默认钩子，系统启动时自动加载。适用于核心业务流程中的固定钩子。

```javascript
// 静态注册示例（在 index.js 中）
const { registerHook } = require('./utils/registerHook');
const onUserRegistered = require('./user/onUserRegistered');

// 注册钩子
registerHook('USER_REGISTERED', onUserRegistered);
```

### 6.2 动态注册

在业务代码中根据需要动态注册钩子，支持条件注册和运行时替换。适用于按需加载或特定条件下的钩子。

```javascript
// 动态注册示例（在业务代码中）
const { registerHook, unregisterHook } = require('../hooks/utils/registerHook');

// 条件性注册钩子
if (config.enableFeatureX) {
  registerHook('USER_REGISTERED', customHandler, { priority: 10 });
}

// 后续可以注销钩子
unregisterHook('USER_REGISTERED', customHandler);
```

### 6.3 钩子扩展最佳实践

1. **优先使用动态注册**: 避免直接修改钩子文件，而是通过注册机制添加新行为
2. **遵循钩子命名规范**: 新增钩子时遵循 `on{Entity}{Action}` 的命名格式
3. **注意执行顺序**: 使用优先级控制多个钩子的执行顺序
4. **异步处理**: 钩子中的耗时操作应使用异步方式处理，避免阻塞主流程
5. **错误隔离**: 钩子中的错误不应影响主业务流程，应做好错误捕获和日志记录
6. **单一职责**: 每个钩子只处理一个具体的业务场景，避免过度耦合

## 7. 冻结范围

以下钩子系统内容被定义为冻结状态：

1. **目录结构**
   - 顶级目录的组织方式和分类逻辑
   - 各模块下钩子的命名和分组规则

2. **钩子命名规范**
   - 钩子文件采用 `on{Entity}{Action}.js` 格式命名
   - 钩子事件采用大写下划线格式（如 `USER_REGISTERED`）

3. **钩子触发点**
   - 在系统中的触发位置和时机
   - 触发钩子时传递的标准参数结构

4. **注册机制**
   - registerHook 工具的接口定义和使用方式
   - 钩子注册和管理的标准流程

5. **导出方式**
   - index.js 中统一导出钩子的方式
   - 钩子模块的标准暴露接口

## 8. 更新与维护

尽管钩子系统结构已冻结，但以下内容需要持续更新：

1. **扩展现有钩子**
   - 在不改变钩子名称和触发时机的前提下，可以扩展钩子内部逻辑
   - 可以通过注册机制添加新的处理函数

2. **新增钩子场景**
   - 在现有钩子分类下，可以根据新业务需求添加新的钩子文件
   - 新钩子应遵循现有的命名和组织规范

3. **优化注册机制**
   - 可以优化 registerHook 工具的内部实现，提高性能和可靠性
   - 可以增强钩子管理功能，如添加监控、调试和可视化工具

4. **钩子文档更新**
   - 新增钩子时应及时更新钩子触发点清单
   - 定期检查和更新钩子的使用说明和最佳实践

---
⚠️ **注意**: 本文档定义的钩子系统结构已冻结，未经架构委员会批准，不得更改钩子的命名规范、目录结构和触发机制。所有扩展应在现有结构框架内进行。 