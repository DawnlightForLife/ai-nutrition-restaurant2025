# 智能营养餐厅 - 分层验证策略文档

*版本: v1.0.0*  
*日期: 2025-05-25*  
*状态: [FROZEN]*

## 设计理念

项目采用了分层验证策略，以确保数据在从用户界面到领域层的流动过程中保持有效和一致。这种策略通过在不同层次实施验证，防止无效数据进入系统的核心领域，同时为用户提供即时反馈。

## 验证层级

### 1. UI层（表单）验证

在UI层使用`formz`库提供表单字段的即时验证和状态反馈。此验证是用户交互的第一道防线，提供即时的、用户友好的错误反馈。

**实现组件：**

- **基础表单输入模型**：
  - `EmailInput` - 电子邮件验证
  - `PasswordInput` - 密码强度和格式验证
  - `PhoneInput` - 手机号格式验证
  - `NutritionProfileInput` - 营养档案信息验证
  - `MealNutritionInfoInput` - 餐品营养信息验证

- **表单状态管理**：
  - `LoginFormState` - 登录表单状态
  - `NutritionFormState` - 营养咨询表单状态

- **表单控制器**：
  - `LoginFormCubit` - 登录表单控制器
  - `NutritionFormCubit` - 营养咨询表单控制器

### 2. 领域模型层验证

在领域模型层使用自定义值对象（Value Objects）保证核心数据的完整性和业务规则的遵守。确保领域模型不会进入不合法状态。

**实现组件：**

- **值对象基础设施**：
  - `ValueObject<T>` - 值对象基类
  - `ValueFailure<T>` - 值验证失败基类
  - `ValueValidators` - 值验证工具类

- **用户领域值对象**：
  - `EmailAddress` - 电子邮件地址值对象
  - `Password` - 密码值对象
  - `PhoneNumber` - 手机号值对象

- **营养领域值对象**：
  - `NutritionProfile` - 营养档案值对象
  - `MealNutritionInfo` - 餐品营养信息值对象

## 验证流程

1. **用户输入** → UI层验证 → 即时反馈
2. UI提交 → **转换为值对象** → 领域层验证 → 业务逻辑处理
3. 领域层处理 → **结果反馈** → UI层更新

## 值对象验证方式

项目使用`dartz`库的`Either<L, R>`类型实现值对象的验证结果表示：

- `Left<ValueFailure<T>>` - 表示验证失败，包含失败详情
- `Right<T>` - 表示验证成功，包含有效值

这种实现方式确保：

1. 值对象一旦创建就包含了验证结果
2. 使用值对象时必须处理验证失败的情况
3. 领域逻辑只处理有效的值，保证领域规则的完整性

## 用例层的衔接

应用层用例作为连接UI验证和领域验证的桥梁，它：

1. 接收UI层提交的数据
2. 验证并转换为领域值对象
3. 执行领域逻辑
4. 将结果反馈回UI层

**实现示例：**

- `CreateNutritionConsultationUseCase` - 创建营养咨询用例

## 实现状态

- [x] UI层表单验证（使用formz）
- [x] 领域模型层值对象验证
- [x] 用例层衔接实现
- [x] 表单状态管理
- [x] 值对象错误处理和展示

## 验证规则一览

### 用户验证规则

| 字段 | UI验证规则 | 领域验证规则 |
|------|------------|-------------|
| 电子邮件 | 非空、正则表达式 | 符合邮箱格式规范 |
| 密码 | 长度≥8、包含大小写字母和数字 | 安全强度检查 |
| 手机号 | 长度11位、纯数字、1开头 | 符合中国手机号规范 |

### 营养档案验证规则

| 字段 | UI验证规则 | 领域验证规则 |
|------|------------|-------------|
| 性别 | 非空、男/女 | 值必须为"男"或"女" |
| 年龄 | 数字、1-120范围 | 1-120范围 |
| 身高 | 数字、50-250范围 | 50-250厘米范围 |
| 体重 | 数字、20-300范围 | 20-300千克范围 |
| 活动水平 | 必选 | 必须为有效值 |
| 健康目标 | 非空 | 至少选择一项 |

### 餐品营养信息验证规则

| 字段 | UI验证规则 | 领域验证规则 |
|------|------------|-------------|
| 卡路里 | 数字、大于0 | 大于0 |
| 蛋白质 | 数字、非负 | 非负 |
| 碳水化合物 | 数字、非负 | 非负 |
| 脂肪 | 数字、非负 | 非负 |
| 宏量营养素计算 | 卡路里计算误差≤10% | 卡路里计算误差≤10% |

## 变更记录

- 2025-05-25: v1.0.0 - 初始版本，实现UI层和领域层验证策略 